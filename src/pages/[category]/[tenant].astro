---
import Layout from "../../layouts/Layout.astro";
import SpecTimeline from "../../components/SpecTimeline.tsx";
import * as fs from "node:fs";
import * as path from "node:path";

export async function getStaticPaths() {
  const generatedDir = path.resolve("generated");

  if (!fs.existsSync(generatedDir)) {
    return [];
  }

  const paths: Array<{
    params: { category: string; tenant: string };
    props: { displayName: string };
  }> = [];

  const categories = fs.readdirSync(generatedDir, { withFileTypes: true });

  for (const categoryEntry of categories) {
    if (!categoryEntry.isDirectory() || categoryEntry.name.startsWith(".")) {
      continue;
    }

    const categoryPath = path.join(generatedDir, categoryEntry.name);
    const tenants = fs.readdirSync(categoryPath, { withFileTypes: true });

    for (const tenantEntry of tenants) {
      if (!tenantEntry.isDirectory() || tenantEntry.name.startsWith(".")) {
        continue;
      }

      // Try to read tenant name from config
      const tenantConfigPath = path.resolve(
        `tenants/${categoryEntry.name}/${tenantEntry.name}.md`,
      );
      let displayName = tenantEntry.name;

      if (fs.existsSync(tenantConfigPath)) {
        const configContent = fs.readFileSync(tenantConfigPath, "utf-8");
        const nameMatch = configContent.match(/^name:\s*(.+)$/m);
        if (nameMatch) {
          displayName = nameMatch[1].trim();
        }
      }

      paths.push({
        params: {
          category: categoryEntry.name,
          tenant: tenantEntry.name,
        },
        props: { displayName },
      });
    }
  }

  return paths;
}

const { category, tenant } = Astro.params;
const { displayName } = Astro.props;
---

<Layout title={`${displayName} â€” ${category}`}>
  <div class="space-y-6">
    <div class="flex items-center gap-4">
      <a
        href="/daily-ui/"
        class="text-sm text-muted-foreground hover:text-foreground transition-colors"
      >
        &larr; Dashboard
      </a>
      <span class="text-muted-foreground/40">|</span>
      <span class="text-sm text-muted-foreground capitalize">{category}</span>
    </div>

    <div>
      <h1 class="text-2xl font-bold tracking-tight">{displayName}</h1>
      <p class="mt-1 text-sm text-muted-foreground capitalize">
        {category} tracker
      </p>
    </div>

    <SpecTimeline
      category={category}
      tenant={tenant}
      storageKey={`${category}/${tenant}`}
      client:load
    />
  </div>
</Layout>
