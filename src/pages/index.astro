---
import Layout from "../layouts/Layout.astro";
import fs from "node:fs";
import path from "node:path";
import yaml from "yaml";

const tenantsDir = path.resolve("tenants");
const tenantIds = fs.readdirSync(tenantsDir).filter((f) => {
  const fullPath = path.join(tenantsDir, f);
  return fs.statSync(fullPath).isDirectory();
});

const tenants = tenantIds
  .map((id) => {
    const personaPath = path.join(tenantsDir, id, "PERSONA.md");
    if (fs.existsSync(personaPath)) {
      try {
        const content = fs.readFileSync(personaPath, "utf-8");
        const match = content.match(/^---\r?\n([\s\S]+?)\r?\n---/);
        const frontmatter = match ? match[1] : "";
        const data = frontmatter ? yaml.parse(frontmatter) : {};
        return { id, name: data.name || id, active: data.active !== false };
      } catch (e) {
        console.error(`Error parsing ${personaPath}:`, e);
      }
    }
    return null;
  })
  .filter((t) => t !== null);
---

<Layout title="Daily UI â€” Tenants">
  <div class="space-y-8">
    <div>
      <h1 class="text-3xl font-bold tracking-tight">Tenants</h1>
      <p class="mt-2 text-muted-foreground">
        Select a tenant to view their personal portal.
      </p>
    </div>

    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
      {
        tenants.map((tenant) => (
          <a
            href={`/daily-ui/${tenant.id}/`}
            class="group block p-6 bg-card border border-border rounded-2xl hover:border-primary/50 transition-all shadow-sm"
          >
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-semibold group-hover:text-primary transition-colors">
                {tenant.name}
              </h2>
              <div
                class={`w-2 h-2 rounded-full ${tenant.active ? "bg-green-500" : "bg-muted"}`}
              />
            </div>
            <p class="mt-2 text-sm text-muted-foreground">
              ID: <code class="bg-muted px-1 rounded">{tenant.id}</code>
            </p>
          </a>
        ))
      }
    </div>
  </div>
</Layout>
